#!/bin/sh
set -e

SAYT_VERSION="${SAYT_VERSION:-v0.0.7}"
if [ "${SAYT_VERSION#v}" = "$SAYT_VERSION" ] && [ "$SAYT_VERSION" != "latest" ]; then
  SAYT_VERSION="v$SAYT_VERSION"
fi
export SAYT_VERSION
SAYT_CACHE_DIR="${XDG_CACHE_HOME:-$HOME/.cache}/sayt"

# Detect OS and Arch
OS=$(uname -s | tr '[:upper:]' '[:lower:]')
ARCH=$(uname -m)

case "$OS" in
  linux)
    case "$ARCH" in
      x86_64) BIN_NAME="sayt-linux-x64" ;;
      aarch64) BIN_NAME="sayt-linux-arm64" ;;
      armv7l) BIN_NAME="sayt-linux-armv7" ;;
      *) echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
    esac
    ;;
  darwin)
    case "$ARCH" in
      x86_64) BIN_NAME="sayt-macos-x64" ;;
      arm64) BIN_NAME="sayt-macos-arm64" ;;
      *) echo "Unsupported architecture: $ARCH" >&2; exit 1 ;;
    esac
    ;;
  *)
    echo "Unsupported OS: $OS" >&2
    exit 1
    ;;
esac

SAYT_URL="https://github.com/bonitao/sayt/releases/download/${SAYT_VERSION}/${BIN_NAME}"
SAYT_BIN="$SAYT_CACHE_DIR/$BIN_NAME"
# Symlink for easier usage
SAYT_LINK="$SAYT_CACHE_DIR/sayt"

mkdir -p "$SAYT_CACHE_DIR"

# Download a file using available tools (no root required)
download_file() {
  URL="$1"
  OUTPUT="$2"

  if command -v curl >/dev/null 2>&1; then
    curl -fsSL -o "$OUTPUT" "$URL" && return 0
  fi
  if command -v wget >/dev/null 2>&1; then
    wget -q -O "$OUTPUT" "$URL" && return 0
  fi
  return 1
}

if [ ! -x "$SAYT_BIN" ]; then
  echo "Downloading sayt ${SAYT_VERSION} ($BIN_NAME)..." >&2
  if download_file "$SAYT_URL" "$SAYT_BIN"; then
    chmod +x "$SAYT_BIN"
    ln -sf "$SAYT_BIN" "$SAYT_LINK"
  else
    echo "Error: Could not download sayt from $SAYT_URL" >&2
    exit 1
  fi
fi

exec "$SAYT_BIN" "$@"
