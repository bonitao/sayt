name: test-install

on:
  workflow_dispatch:

jobs:
  test-install:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Install sayt (Unix)
        if: runner.os != 'Windows'
        run: |
          set -x
          curl -fsSL https://raw.githubusercontent.com/bonitao/sayt/refs/heads/main/install | sh

      - name: Install sayt (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Set-PSDebug -Trace 1
          irm https://raw.githubusercontent.com/bonitao/sayt/refs/heads/main/install | iex

      - name: Verify sayt is in PATH (Unix)
        if: runner.os != 'Windows'
        run: |
          echo "PATH: $PATH"
          which sayt || echo "sayt not found in PATH"
          ls -la ~/.local/bin/ || true
          ~/.local/bin/sayt --version || sayt --version || echo "sayt --version failed"

      - name: Verify sayt is in PATH (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          Write-Host "PATH: $env:PATH"
          Get-Command sayt -ErrorAction SilentlyContinue || Write-Host "sayt not found in PATH"
          $localBin = Join-Path $env:LOCALAPPDATA "sayt\bin"
          Get-ChildItem $localBin -ErrorAction SilentlyContinue || Write-Host "Local bin not found"
          & "$localBin\sayt.exe" --version 2>&1 || Write-Host "sayt --version failed"

      - name: Test sayt doctor (Unix)
        if: runner.os != 'Windows'
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          sayt doctor || echo "sayt doctor failed with exit code $?"

      - name: Test sayt doctor (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $localBin = Join-Path $env:LOCALAPPDATA "sayt\bin"
          $env:PATH = "$localBin;$env:PATH"
          sayt doctor 2>&1 || Write-Host "sayt doctor failed"
